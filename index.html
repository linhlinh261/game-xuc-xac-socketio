<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò Chơi Cược Xúc Xắc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .dice {
            width: 80px;
            height: 80px;
            padding: 10px;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
        }
        .dot {
            width: 14px;
            height: 14px;
            background-color: black;
            border-radius: 50%;
        }
        .dot-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Positions for dots */
        .dot-1:nth-child(1) { grid-area: 2 / 2; }
        .dot-2:nth-child(1) { grid-area: 1 / 1; }
        .dot-2:nth-child(2) { grid-area: 3 / 3; }
        .dot-3:nth-child(1) { grid-area: 1 / 1; }
        .dot-3:nth-child(2) { grid-area: 2 / 2; }
        .dot-3:nth-child(3) { grid-area: 3 / 3; }
        .dot-4:nth-child(1) { grid-area: 1 / 1; }
        .dot-4:nth-child(2) { grid-area: 1 / 3; }
        .dot-4:nth-child(3) { grid-area: 3 / 1; }
        .dot-4:nth-child(4) { grid-area: 3 / 3; }
        .dot-5:nth-child(1) { grid-area: 1 / 1; }
        .dot-5:nth-child(2) { grid-area: 1 / 3; }
        .dot-5:nth-child(3) { grid-area: 2 / 2; }
        .dot-5:nth-child(4) { grid-area: 3 / 1; }
        .dot-5:nth-child(5) { grid-area: 3 / 3; }
        .dot-6:nth-child(1) { grid-area: 1 / 1; }
        .dot-6:nth-child(2) { grid-area: 1 / 3; }
        .dot-6:nth-child(3) { grid-area: 2 / 1; }
        .dot-6:nth-child(4) { grid-area: 2 / 3; }
        .dot-6:nth-child(5) { grid-area: 3 / 1; }
        .dot-6:nth-child(6) { grid-area: 3 / 3; }

        .bet-circle.selected-by-me {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #1d4ed8; /* blue-700 */
        }
        .bet-circle.selected-by-opponent {
            background-color: #ef4444; /* red-500 */
            color: white;
            border-color: #b91c1c; /* red-700 */
        }
        .bet-circle.correct-guess {
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4">

        <!-- Notification Toast -->
        <div id="notification-toast" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50 opacity-0 pointer-events-none">
            This is a message.
        </div>

        <!-- Name Input View -->
        <div id="name-view">
            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-3xl font-bold mb-6 text-gray-700">Chào mừng bạn đến với Cược Xúc Xắc</h1>
                <label for="player-name" class="block text-lg font-medium mb-2">Nhập tên của bạn để bắt đầu</label>
                <input type="text" id="player-name" class="w-full max-w-sm mx-auto p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition disabled:bg-gray-200" disabled>
                <button id="submit-name-btn" class="mt-6 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>Vào Sảnh Chờ</button>
            </div>
        </div>
        
        <!-- Lobby View -->
        <div id="lobby-view" class="hidden">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-700">Sảnh Chờ - Chọn Phòng</h1>
            <div id="room-list" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                <!-- Rooms will be generated by JS -->
            </div>
        </div>

        <!-- Game View -->
        <div id="game-view" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg w-full">
                <!-- Header -->
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Phòng <span id="room-number"></span></h2>
                        <p class="text-gray-500">ID Phòng: <span id="room-id-display" class="font-mono text-xs"></span></p>
                    </div>
                    <button id="leave-room-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Rời Phòng</button>
                </div>

                <!-- Player Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-center">
                    <div id="player-1-info" class="p-4 bg-blue-100 rounded-lg border-2 border-blue-300"></div>
                    <div id="player-2-info" class="p-4 bg-red-100 rounded-lg border-2 border-red-300"></div>
                </div>

                <!-- Game Status/Instructions -->
                <div id="game-status" class="text-center text-xl font-semibold my-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg">
                    Đang chờ người chơi khác...
                </div>

                <!-- Main Game Area -->
                <div id="main-game-area" class="mt-6">
                    <!-- Coin Toss -->
                    <div id="coin-toss-view" class="hidden text-center">
                        <h3 class="text-lg font-medium mb-4">Tung đồng xu để quyết định ai đi trước! Chọn một mặt:</h3>
                        <div class="flex justify-center gap-4">
                            <button id="heads-btn" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 transition text-lg">Sấp</button>
                            <button id="tails-btn" class="bg-yellow-400 text-black font-bold py-3 px-6 rounded-lg hover:bg-yellow-500 transition text-lg">Ngửa</button>
                        </div>
                    </div>

                    <!-- Betting Board -->
                    <div id="betting-view" class="hidden">
                        <div id="betting-board" class="flex flex-wrap justify-center gap-3">
                           <!-- Bet circles will be generated by JS -->
                        </div>
                    </div>

                    <!-- Dice Roll -->
                    <div id="dice-roll-view" class="hidden flex flex-col items-center justify-center min-h-[180px]">
                        <p class="text-2xl font-bold mb-4" id="rolling-text">Đang tung xúc xắc...</p>
                        <div class="flex gap-6">
                           <div id="dice1" class="dice bg-white shadow-md"></div>
                           <div id="dice2" class="dice bg-white shadow-md"></div>
                        </div>
                    </div>

                    <!-- Result View -->
                     <div id="result-view" class="hidden text-center">
                        <h3 class="text-2xl font-bold mb-2">Kết quả là: <span id="dice-result-value" class="text-blue-600"></span></h3>
                        <p id="winner-text" class="text-xl font-semibold text-green-600 mb-4"></p>
                        <button id="play-again-btn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-600 transition">Chơi Lại</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CẤU HÌNH FIREBASE ---
        // QUAN TRỌNG: Dán cấu hình Firebase của bạn vào đây để chạy trên Render/GitHub.
        const userFirebaseConfig = {
          // apiKey: "AIza...",
          // authDomain: "your-project.firebaseapp.com",
          // projectId: "your-project",
          // storageBucket: "your-project.appspot.com",
          // messagingSenderId: "...",
          // appId: "..."
        };

        const firebaseConfig = Object.keys(userFirebaseConfig).length > 1 ? userFirebaseConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
        const appId = firebaseConfig.projectId || (typeof __app_id !== 'undefined' ? __app_id : 'dice-bet-game-default');
        // -------------------------

        // Firebase Initialization
        let app, db, auth;
        try {
            if (!firebaseConfig.apiKey) {
                 throw new Error("Cấu hình Firebase bị thiếu.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Lỗi khởi tạo Firebase: ", e);
            document.getElementById('name-view').innerHTML = `<p class="text-red-500 p-4">Lỗi cấu hình Firebase. Không thể bắt đầu trò chơi. Vui lòng kiểm tra lại mã cấu hình.</p>`;
        }

        // App State
        let userId = null;
        let playerName = '';
        let currentRoomId = null;
        let roomUnsubscribe = null;
        let lobbyUnsubscribe = null;
        let hasJoinedRoom = false;

        // UI Elements
        const nameView = document.getElementById('name-view');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const playerNameInput = document.getElementById('player-name');
        const submitNameBtn = document.getElementById('submit-name-btn');
        const roomList = document.getElementById('room-list');
        const gameStatus = document.getElementById('game-status');
        const coinTossView = document.getElementById('coin-toss-view');
        const bettingView = document.getElementById('betting-view');
        const diceRollView = document.getElementById('dice-roll-view');
        const resultView = document.getElementById('result-view');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- UTILITY ---
        function showNotification(message) {
            const toast = document.getElementById('notification-toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        // --- INITIALIZATION ---
        function initializeAppSequence() {
            if (!auth) return; 

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated with User ID:", userId);
                    playerNameInput.disabled = false;
                    submitNameBtn.disabled = false;
                } else {
                    userId = null;
                    playerNameInput.disabled = true;
                    submitNameBtn.disabled = true;
                }
            });

            signInAnonymously(auth).catch((error) => {
                console.error("Anonymous sign-in failed:", error);
                showNotification("Không thể kết nối đến máy chủ. Hãy chắc chắn bạn đã bật đăng nhập ẩn danh trong Firebase.");
            });
        }

        // --- LOBBY LOGIC ---
        function showLobby() {
            nameView.classList.add('hidden');
            lobbyView.classList.remove('hidden');
            gameView.classList.add('hidden');
            listenToLobbyUpdates();
        }
        
        submitNameBtn.addEventListener('click', () => {
            if (!userId) {
                showNotification("Đang kết nối, vui lòng thử lại sau giây lát.");
                return;
            }
            const name = playerNameInput.value.trim();
            if (name) {
                playerName = name;
                showLobby();
            } else {
                showNotification('Vui lòng nhập tên của bạn!');
            }
        });

        function listenToLobbyUpdates() {
            if(lobbyUnsubscribe) lobbyUnsubscribe();

            const roomsColRef = collection(db, `artifacts/${appId}/public/data/rooms`);
            lobbyUnsubscribe = onSnapshot(roomsColRef, (snapshot) => {
                const roomsData = {};
                snapshot.forEach(doc => {
                    roomsData[doc.id] = doc.data();
                });
                renderRooms(roomsData);
            }, (error) => {
                console.error("Lỗi Firestore:", error);
                showNotification("Không thể tải danh sách phòng. Hãy chắc chắn bạn đã cài đặt Firestore và quy tắc bảo mật.");
            });
        }

        function renderRooms(roomsData = {}) {
            roomList.innerHTML = '';
            for (let i = 1; i <= 30; i++) {
                const roomId = `room-${i}`;
                const roomElement = document.createElement('div');
                const room = roomsData[roomId];
                
                let playerCount = 0;
                let isFull = false;

                if (room) {
                    playerCount = room.playerIds?.length || 0;
                    if (playerCount >= 2) isFull = true;
                }
                
                roomElement.className = `p-4 rounded-lg text-center font-bold text-lg shadow-md transition cursor-pointer ${isFull ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-white hover:bg-blue-100'}`;
                roomElement.textContent = `Phòng ${i} (${playerCount}/2)`;
                roomElement.dataset.roomId = roomId;

                if (!isFull) {
                    roomElement.addEventListener('click', () => joinRoom(roomId, i));
                }
                roomList.appendChild(roomElement);
            }
        }

        // --- GAME LOGIC ---
        async function joinRoom(roomId, roomNumber) {
            if (!playerName || !userId) return;

            if (lobbyUnsubscribe) { lobbyUnsubscribe(); lobbyUnsubscribe = null; }

            currentRoomId = roomId;
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);

            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomDocRef);
                    if (!roomDoc.exists()) {
                        transaction.set(roomDocRef, {
                            playerIds: [userId],
                            players: { [userId]: { name: playerName, score: 0 } },
                            gameState: 'waiting'
                        });
                    } else {
                        const data = roomDoc.data();
                        if (data.playerIds.length >= 2) throw new Error("Phòng đã đầy!");
                        if (data.playerIds.includes(userId)) return;
                        
                        data.playerIds.push(userId);
                        data.players[userId] = { name: playerName, score: 0 };
                        data.gameState = 'coinToss';
                        transaction.update(roomDocRef, data);
                    }
                });

                hasJoinedRoom = true;
                lobbyView.classList.add('hidden');
                gameView.classList.remove('hidden');
                document.getElementById('room-number').textContent = roomNumber;
                document.getElementById('room-id-display').textContent = roomId;
                listenToRoomUpdates();

            } catch (e) {
                console.error("Lỗi vào phòng: ", e);
                showNotification(e.message);
                currentRoomId = null;
                showLobby();
            }
        }
        
        async function leaveRoom() {
            if (!currentRoomId || !userId) return;
            
            hasJoinedRoom = false;
            const roomToLeaveId = currentRoomId;
            currentRoomId = null; 

            if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }

            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomToLeaveId);
            
            try {
                 await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomDocRef);
                    if(roomDoc.exists()){
                        const data = roomDoc.data();
                        const newPlayerIds = data.playerIds.filter(id => id !== userId);
                        delete data.players[userId];
                        
                        if(newPlayerIds.length === 0){
                            transaction.delete(roomDocRef);
                        } else {
                             transaction.update(roomDocRef, {
                                playerIds: newPlayerIds,
                                players: data.players,
                                gameState: 'waiting', 
                                turn: null, coinTossWinner: null, diceResult: null, roundWinner: null,
                             });
                        }
                    }
                 });
            } catch (e) {
                console.error("Lỗi rời phòng: ", e);
            } finally {
                showLobby();
            }
        }
        leaveRoomBtn.addEventListener('click', leaveRoom);


        function listenToRoomUpdates() {
            if (roomUnsubscribe) roomUnsubscribe();
            
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            roomUnsubscribe = onSnapshot(roomDocRef, (doc) => {
                if (!hasJoinedRoom) return;
                if (doc.exists()) {
                    updateUI(doc.data());
                } else {
                    showNotification("Phòng không còn tồn tại. Quay trở lại sảnh chờ.", false);
                    leaveRoom();
                }
            }, (error) => {
                console.error("Lỗi lắng nghe phòng:", error);
                showNotification("Mất kết nối với phòng chơi.");
                leaveRoom();
            });
        }
        
        function updateUI(data) {
            if (!data || !data.players || !userId) return;
            
            const playerIds = data.playerIds || [];
            const me = data.players[userId];
            const opponentId = playerIds.find(id => id !== userId);
            const opponent = opponentId ? data.players[opponentId] : null;

            const updatePlayerBox = (elementId, playerData, isMe) => {
                 const box = document.getElementById(elementId);
                 if (!playerData) {
                    box.innerHTML = `<p class="text-gray-500">Đang chờ...</p>`;
                    return;
                 }
                 box.innerHTML = `
                    <h3 class="text-lg font-bold">${playerData.name} ${isMe ? '(Bạn)' : ''}</h3>
                    <p class="text-2xl font-black text-indigo-600">${playerData.score || 0} Điểm</p>
                    ${playerData.diceBet ? `<p class="mt-1">Đã cược: <span class="font-bold">${playerData.diceBet}</span></p>` : ''}
                    ${playerData.coinTossChoice ? `<p class="mt-1">Chọn đồng xu: <span class="font-bold capitalize">${playerData.coinTossChoice === 'heads' ? 'Sấp' : 'Ngửa'}</span></p>` : ''}
                 `;
            };

            updatePlayerBox('player-1-info', me, true);
            updatePlayerBox('player-2-info', opponent, false);

            coinTossView.classList.add('hidden');
            bettingView.classList.add('hidden');
            diceRollView.classList.add('hidden');
            resultView.classList.add('hidden');

            switch(data.gameState) {
                case 'waiting':
                    gameStatus.textContent = 'Đang chờ người chơi khác...';
                    break;
                case 'coinToss':
                    handleCoinTossState(data);
                    break;
                case 'betting':
                    handleBettingState(data);
                    break;
                case 'rolling':
                    handleRollingState(data);
                    break;
                case 'result':
                    handleResultState(data);
                    break;
            }
        }
        
        async function handleCoinTossState(data) {
            const me = data.players[userId];
            if (me.coinTossChoice) {
                gameStatus.textContent = 'Đã chọn. Đang chờ đối thủ...';
            } else {
                gameStatus.textContent = 'Đến lượt bạn! Hãy chọn Sấp hoặc Ngửa.';
                coinTossView.classList.remove('hidden');
            }

            const allPlayersChosen = data.playerIds.length === 2 && data.playerIds.every(id => data.players[id].coinTossChoice);
            if (allPlayersChosen && data.playerIds[0] === userId) {
                const coinResult = Math.random() < 0.5 ? 'heads' : 'tails';
                const winnerId = data.playerIds.find(id => data.players[id].coinTossChoice === coinResult) || data.playerIds[0];
                
                const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                await updateDoc(roomDocRef, { gameState: 'betting', coinTossWinner: winnerId, turn: winnerId });
            }
        }

        async function selectCoinToss(choice) {
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            await updateDoc(roomDocRef, { [`players.${userId}.coinTossChoice`]: choice });
        }
        document.getElementById('heads-btn').onclick = () => selectCoinToss('heads');
        document.getElementById('tails-btn').onclick = () => selectCoinToss('tails');

        async function handleBettingState(data) {
            if (data.turn === userId) {
                gameStatus.textContent = 'Đến lượt bạn! Hãy chọn một số.';
                bettingView.classList.remove('hidden');
                renderBettingBoard(data);
            } else {
                gameStatus.textContent = `Đang chờ đối thủ đặt cược...`;
            }
        }

        function renderBettingBoard(data) {
            const board = document.getElementById('betting-board');
            board.innerHTML = '';
            const me = data.players[userId];
            const opponentId = data.playerIds.find(id => id !== userId);
            const opponent = opponentId ? data.players[opponentId] : null;

            for (let i = 2; i <= 12; i++) {
                const circle = document.createElement('button');
                circle.textContent = i;
                let isSelectedByOpponent = opponent && opponent.diceBet === i;
                let isSelectedByMe = me.diceBet === i;
                let isSelected = isSelectedByMe || isSelectedByOpponent;
                
                let classes = 'bet-circle w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold border-4 transition ';
                
                if (isSelectedByMe) classes += 'selected-by-me ';
                else if (isSelectedByOpponent) classes += 'selected-by-opponent ';
                else classes += 'bg-white border-gray-300 ';

                if (data.turn === userId) classes += 'hover:bg-blue-200 cursor-pointer';
                else classes += 'cursor-not-allowed';
                
                if (data.gameState === 'result' && i === data.diceResult) classes += ' correct-guess';

                circle.className = classes;
                circle.disabled = data.turn !== userId || isSelected;
                if(!circle.disabled) circle.onclick = () => placeBet(i);
                board.appendChild(circle);
            }
        }
        
        async function placeBet(number) {
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            const roomSnapshot = await getDoc(roomDocRef);
            if (!roomSnapshot.exists()) return;
            const opponentId = roomSnapshot.data().playerIds.find(id => id !== userId);
            
            const allHaveBet = !!roomSnapshot.data().players[opponentId]?.diceBet;

            await updateDoc(roomDocRef, {
                [`players.${userId}.diceBet`]: number,
                turn: opponentId,
                gameState: allHaveBet ? 'rolling' : 'betting'
            });
        }

        async function handleRollingState(data) {
            gameStatus.textContent = 'Đang tung xúc xắc...';
            diceRollView.classList.remove('hidden');
            document.getElementById('rolling-text').textContent = 'Tất cả đã cược! Đang tung xúc xắc...';
            animateDice();

            if (data.playerIds[0] === userId) {
                setTimeout(async () => {
                    const die1 = Math.floor(Math.random() * 6) + 1;
                    const die2 = Math.floor(Math.random() * 6) + 1;
                    const total = die1 + die2;

                    const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                    const currentDoc = await getDoc(roomDocRef);
                    if (!currentDoc.exists()) return;
                    
                    const p1 = currentDoc.data().players[data.playerIds[0]];
                    const p2 = currentDoc.data().players[data.playerIds[1]];
                    let p1Won = p1.diceBet === total;
                    let p2Won = p2.diceBet === total;

                    await updateDoc(roomDocRef, {
                        gameState: 'result',
                        diceResult: total,
                        roundWinner: p1Won && p2Won ? 'tie' : (p1Won ? data.playerIds[0] : (p2Won ? data.playerIds[1] : 'none')),
                        [`players.${data.playerIds[0]}.score`]: p1.score + (p1Won ? 1 : 0),
                        [`players.${data.playerIds[1]}.score`]: p2.score + (p2Won ? 1 : 0),
                        diceFaces: [die1, die2]
                    });
                }, 2500);
            }
        }

        function animateDice() {
            const dice1El = document.getElementById('dice1');
            const dice2El = document.getElementById('dice2');
            let counter = 0;
            const interval = setInterval(() => {
                const r1 = Math.floor(Math.random() * 6) + 1;
                const r2 = Math.floor(Math.random() * 6) + 1;
                dice1El.innerHTML = createDiceDots(r1);
                dice2El.innerHTML = createDiceDots(r2);
                counter++;
                if (counter > 15) clearInterval(interval);
            }, 150);
        }

        function createDiceDots(face) {
            let dots = '';
            for(let i=0; i < face; i++) {
                dots += `<div class="dot-container"><div class="dot"></div></div>`;
            }
            return `<div class="dice bg-white shadow-md dot-${face}">${dots}</div>`;
        }
        
        function handleResultState(data) {
            gameStatus.textContent = 'Vòng chơi kết thúc!';
            resultView.classList.remove('hidden');
            bettingView.classList.remove('hidden'); 
            renderBettingBoard(data); 

            document.getElementById('dice-result-value').textContent = data.diceResult;
            const winnerText = document.getElementById('winner-text');

            if (data.diceFaces) {
                diceRollView.classList.remove('hidden');
                document.getElementById('rolling-text').textContent = "Kết quả xúc xắc:";
                document.getElementById('dice1').innerHTML = createDiceDots(data.diceFaces[0]);
                document.getElementById('dice2').innerHTML = createDiceDots(data.diceFaces[1]);
            }
            
            if (data.roundWinner === 'none') {
                winnerText.textContent = 'Không ai đoán trúng!';
            } else if (data.roundWinner === 'tie') {
                winnerText.textContent = 'Cả hai người chơi đều đoán trúng!';
            } else {
                const winnerName = data.players[data.roundWinner].name;
                winnerText.textContent = `${winnerName} đã thắng vòng này!`;
            }
            
            const me = data.players[userId];
            if (me && me.wantsToPlayAgain) {
                playAgainBtn.textContent = 'Đang chờ đối thủ...';
                playAgainBtn.disabled = true;
            } else {
                playAgainBtn.textContent = 'Chơi Lại';
                playAgainBtn.disabled = false;
            }

             if (data.playerIds.length === 2 && data.playerIds.every(id => data.players[id].wantsToPlayAgain)) {
                 if(data.playerIds[0] === userId) resetForNewRound();
             }
        }
        
        playAgainBtn.addEventListener('click', async () => {
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            await updateDoc(roomDocRef, { [`players.${userId}.wantsToPlayAgain`]: true });
        });

        async function resetForNewRound() {
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            const roomDoc = await getDoc(roomDocRef);
            if (!roomDoc.exists()) return;

            const data = roomDoc.data();
            Object.keys(data.players).forEach(id => {
                data.players[id] = { ...data.players[id], coinTossChoice: null, diceBet: null, wantsToPlayAgain: false };
            });
            
            await updateDoc(roomDocRef, {
                players: data.players, 
                gameState: 'coinToss', 
                turn: null,
                coinTossWinner: null, 
                diceResult: null, 
                roundWinner: null
            });
        }

        initializeAppSequence();
    </script>
</body>
</html>
